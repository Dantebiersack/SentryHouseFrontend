<!-- Listado -->
<div *ngIf="!mostrarEditor()" class="p-8 max-w-7xl mx-auto space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-3xl font-bold text-gray-800">Compras a Proveedores</h2>
    <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md shadow"
            (click)="nuevaCompra()">
      + Nueva compra
    </button>
  </div>

  <!-- Filtros -->
  <div class="grid grid-cols-1 md:grid-cols-5 gap-3 bg-white p-4 rounded-md shadow">
    <select class="border rounded p-2" [(ngModel)]="filtros.estado">
      <option [ngValue]="null">Todos los estatus</option>
      <option [ngValue]="EstadoCompra.Borrador">Borrador</option>
      <option [ngValue]="EstadoCompra.Ordenada">Ordenada</option>
      <option [ngValue]="EstadoCompra.ParcialmenteRecibida">Parcialmente recibida</option>
      <option [ngValue]="EstadoCompra.Recibida">Recibida</option>
      <option [ngValue]="EstadoCompra.Cancelada">Cancelada</option>
    </select>

    <select class="border rounded p-2" [(ngModel)]="filtros.proveedorId">
      <option [ngValue]="null">Todos los proveedores</option>
      <option *ngFor="let p of proveedores()" [ngValue]="p.id">{{ p.nombre }}</option>
    </select>

    <input type="date" class="border rounded p-2" [(ngModel)]="filtros.from" />
    <input type="date" class="border rounded p-2" [(ngModel)]="filtros.to" />
    <button class="border rounded p-2 hover:bg-gray-50" (click)="cargarCompras()">Aplicar</button>
  </div>

  <!-- Tabla -->
  <div class="overflow-x-auto bg-white rounded-md shadow">
    <table class="min-w-full">
      <thead class="bg-gray-100">
        <tr>
          <th class="text-left p-3">Fecha</th>
          <th class="text-left p-3">Proveedor</th>
          <th class="text-right p-3">Subtotal</th>
          <th class="text-right p-3">IVA</th>
          <th class="text-right p-3">Total</th>
          <th class="text-left p-3">Estatus</th>
          <th class="text-right p-3">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of compras()"
            class="border-t hover:bg-gray-50">
          <td class="p-3">{{ c.fecha | date:'yyyy-MM-dd' }}</td>
          <td class="p-3">{{ c.proveedorNombre }}</td>
          <td class="p-3 text-right">{{ c.subtotal | number:'1.2-2' }}</td>
          <td class="p-3 text-right">{{ c.iva | number:'1.2-2' }}</td>
          <td class="p-3 text-right font-semibold">{{ c.total | number:'1.2-2' }}</td>
          <td class="p-3">
            <span class="px-2 py-1 text-xs rounded"
                  [ngClass]="badgeClass(c.estado)">{{ estadoLabel(c.estado) }}</span>
          </td>
          <td class="p-3 text-right space-x-2">
            <button class="text-blue-600 hover:underline" (click)="abrirDetalle(c.id)">Ver</button>
            <button class="text-green-700 hover:underline" *ngIf="c.estado===EstadoCompra.Ordenada || c.estado===EstadoCompra.Borrador"
                    (click)="recibirCompra(c.id)">Recibir</button>
            <button class="text-amber-700 hover:underline" *ngIf="c.estado!==EstadoCompra.Cancelada && c.estado!==EstadoCompra.Recibida"
                    (click)="cancelarCompra(c.id)">Cancelar</button>
            <button class="text-red-600 hover:underline" *ngIf="c.estado===EstadoCompra.Borrador || c.estado===EstadoCompra.Cancelada"
                    (click)="eliminarCompra(c.id)">Eliminar</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Editor / Detalle -->
<div *ngIf="mostrarEditor()" class="p-8 max-w-6xl mx-auto space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-bold">
      {{ compraIdActual() ? 'Compra #' + compraIdActual() : 'Nueva compra' }}
    </h2>
    <button class="text-gray-600 underline" (click)="cerrarEditor()">Regresar</button>
  </div>

  <!-- Encabezado -->
  <form [formGroup]="form" class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-white p-4 rounded-md shadow">
    <div class="md:col-span-2">
      <label class="text-sm text-gray-600">Proveedor</label>
      <select class="border rounded p-2 w-full" formControlName="proveedorId" [disabled]="bloquearEdicionEncabezado()">
        <option [ngValue]="null">Seleccione...</option>
        <option *ngFor="let p of proveedores()" [ngValue]="p.id">{{ p.nombre }}</option>
      </select>
    </div>

    <div>
      <label class="text-sm text-gray-600">Fecha</label>
      <input type="date" class="border rounded p-2 w-full" formControlName="fecha" [disabled]="bloquearEdicionEncabezado()"/>
    </div>

    <div>
      <label class="text-sm text-gray-600">Documento</label>
      <input type="text" class="border rounded p-2 w-full" formControlName="numeroDocumento" [disabled]="bloquearEdicionEncabezado()"/>
    </div>

    <div class="md:col-span-4">
      <label class="text-sm text-gray-600">Notas</label>
      <textarea rows="2" class="border rounded p-2 w-full" formControlName="notas" [disabled]="bloquearEdicionEncabezado()"></textarea>
    </div>

    <div class="md:col-span-4 flex gap-3">
      <button type="button" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800"
              (click)="guardarEncabezado()" *ngIf="!compraIdActual()">Guardar compra</button>

      <button type="button" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800"
              (click)="actualizarEncabezado()" *ngIf="compraIdActual() && !bloquearEdicionEncabezado()">Actualizar</button>
    </div>
  </form>

  <!-- Líneas (crear antes de guardar) -->
  <div *ngIf="!compraIdActual()" class="bg-white p-4 rounded-md shadow space-y-3">
    <h3 class="font-semibold">Líneas</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead class="bg-gray-100">
          <tr>
            <th class="text-left p-2">Materia prima</th>
            <th class="text-right p-2">Cantidad</th>
            <th class="text-right p-2">Precio</th>
            <th class="text-right p-2">IVA %</th>
            <th class="text-right p-2">Subtotal</th>
            <th class="text-right p-2">IVA</th>
            <th class="text-right p-2">Total</th>
            <th class="p-2"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let li of lineas(); let i = index" class="border-t">
            <td class="p-2">
              <select class="border rounded p-2" [ngModel]="li.materiaPrimaId" (ngModelChange)="updateLinea(i, { materiaPrimaId: $event })">
                <option [ngValue]="null">Seleccione...</option>
                <option *ngFor="let m of materias()" [ngValue]="m.id">{{ m.nombreProducto }}</option>
              </select>
            </td>
            <td class="p-2 text-right">
              <input type="number" class="border rounded p-2 w-28 text-right"
                     [ngModel]="li.cantidad" (ngModelChange)="updateLinea(i, { cantidad: $event })"/>
            </td>
            <td class="p-2 text-right">
              <input type="number" step="0.01" class="border rounded p-2 w-28 text-right"
                     [ngModel]="li.precioUnitario" (ngModelChange)="updateLinea(i, { precioUnitario: $event })"/>
            </td>
            <td class="p-2 text-right">
              <input type="number" step="0.01" class="border rounded p-2 w-24 text-right"
                     [ngModel]="li.ivaPorcentaje" (ngModelChange)="updateLinea(i, { ivaPorcentaje: $event })"/>
            </td>
            <td class="p-2 text-right">{{ calcSub(li) | number:'1.2-2' }}</td>
            <td class="p-2 text-right">{{ calcIva(li) | number:'1.2-2' }}</td>
            <td class="p-2 text-right font-semibold">{{ calcTotal(li) | number:'1.2-2' }}</td>
            <td class="p-2 text-right">
              <button class="text-red-600 hover:underline" (click)="removerLinea(i)">Quitar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div><button class="border rounded px-3 py-1" (click)="agregarLinea()">+ Agregar línea</button></div>

    <div class="text-right space-y-1">
      <div>Subtotal: <b>{{ totales().subtotal | number:'1.2-2' }}</b></div>
      <div>IVA: <b>{{ totales().iva | number:'1.2-2' }}</b></div>
      <div>Total: <b>{{ totales().total | number:'1.2-2' }}</b></div>
    </div>

    <div class="pt-2">
      <button class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800"
              (click)="crearCompra()">Crear compra</button>
    </div>
  </div>

  <!-- Detalle (compra ya creada) -->
  <div *ngIf="compraIdActual()" class="bg-white p-4 rounded-md shadow space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="font-semibold">Detalle de líneas</h3>
      <div class="space-x-3">
        <button class="bg-green-700 text-white px-3 py-1 rounded"
                (click)="recibirCompra(compraIdActual()!)"
                [disabled]="bloquearCierre()">Recibir</button>
        <button class="bg-amber-700 text-white px-3 py-1 rounded"
                (click)="cancelarCompra(compraIdActual()!)"
                [disabled]="bloquearCierre()">Cancelar</button>
      </div>
    </div>

    <!-- Agregar nueva línea -->
    <div class="flex flex-wrap gap-2 items-end">
      <select class="border rounded p-2" [(ngModel)]="nuevaLinea.materiaPrimaId">
        <option [ngValue]="null">Materia...</option>
        <option *ngFor="let m of materias()" [ngValue]="m.id">{{ m.nombreProducto }}</option>
      </select>
      <input type="number" class="border rounded p-2 w-28" placeholder="Cantidad" [(ngModel)]="nuevaLinea.cantidad">
      <input type="number" step="0.01" class="border rounded p-2 w-28" placeholder="Precio" [(ngModel)]="nuevaLinea.precioUnitario">
      <input type="number" step="0.01" class="border rounded p-2 w-24" placeholder="IVA %" [(ngModel)]="nuevaLinea.ivaPorcentaje">
      <button class="border rounded px-3 py-2" (click)="agregarDetalleServidor()">Agregar</button>
    </div>

    <!-- Tabla de líneas -->
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead class="bg-gray-100">
          <tr>
            <th class="text-left p-2">Materia</th>
            <th class="text-right p-2">Cantidad</th>
            <th class="text-right p-2">Precio</th>
            <th class="text-right p-2">IVA %</th>
            <th class="text-right p-2">Subtotal</th>
            <th class="text-right p-2">IVA</th>
            <th class="text-right p-2">Total</th>
            <th class="p-2"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of compraDetalle()?.detalles" class="border-t">
            <td class="p-2">{{ d.materiaPrimaNombre }}</td>
            <td class="p-2 text-right">{{ d.cantidad }}</td>
            <td class="p-2 text-right">{{ d.precioUnitario | number:'1.2-2' }}</td>
            <td class="p-2 text-right">{{ d.ivaPorcentaje | number:'1.2-2' }}</td>
            <td class="p-2 text-right">{{ d.subtotal | number:'1.2-2' }}</td>
            <td class="p-2 text-right">{{ d.iva | number:'1.2-2' }}</td>
            <td class="p-2 text-right font-semibold">{{ d.totalLinea | number:'1.2-2' }}</td>
            <td class="p-2 text-right">
              <button class="text-red-600 hover:underline" (click)="eliminarDetalleServidor(d.id)">Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="text-right space-y-1">
      <div>Subtotal: <b>{{ compraDetalle()?.subtotal | number:'1.2-2' }}</b></div>
      <div>IVA: <b>{{ compraDetalle()?.iva | number:'1.2-2' }}</b></div>
      <div>Total: <b>{{ compraDetalle()?.total | number:'1.2-2' }}</b></div>
    </div>
  </div>
</div>
