<!-- Lista de Servicios -->
<div *ngIf="!mostrarFormulario()" class="p-8 max-w-7xl mx-auto">
  <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Servicios</h2>

  <div class="flex justify-between items-center mb-6">
    <button
      class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700"
      (click)="
        mostrarFormulario.set(true); modoEdicion.set(false); form.reset()
      "
    >
      + Agregar servicio
    </button>

    <input
      type="text"
      [(ngModel)]="busqueda"
      placeholder="Buscar servicio..."
      class="p-2 border rounded w-64 shadow-sm"
    />
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    <div
      *ngFor="let servicio of serviciosFiltrados()"
      class="bg-white border rounded-lg shadow p-5 hover:shadow-md transition"
    >
      <h3 class="text-xl font-bold text-indigo-700 mb-2">
        {{ servicio.nombre }}
      </h3>
      <p class="text-gray-700 text-sm mb-3">{{ servicio.descripcion }}</p>

      <!-- Toggle materiales -->
      <div class="mb-3">
        <button
          class="text-indigo-600 hover:underline"
          (click)="toggleMateriales(servicio)"
        >
          {{
            openBom()[servicio.id!] ? "Ocultar materiales" : "Ver materiales"
          }}
        </button>
      </div>

      <!-- Lista de materiales (BOM) -->
      <div *ngIf="openBom()[servicio.id!]">
        <div *ngIf="loadingBom()[servicio.id!]" class="text-sm text-gray-500">
          Cargando...
        </div>

        <ul
          *ngIf="
            !loadingBom()[servicio.id!] && (bom()[servicio.id!] || []).length
          "
          class="space-y-1"
        >
          <li
            *ngFor="let m of bom()[servicio.id!]"
            class="text-sm text-gray-700 flex justify-between"
          >
            <span>{{
              m.materiaPrimaNombre || nombreMateria(m.materiaPrimaId)
            }}</span>
            <span>{{ m.cantidad }} {{ m.unidad || "" }}</span>
          </li>
        </ul>

        <div
          *ngIf="
            !loadingBom()[servicio.id!] && !(bom()[servicio.id!] || []).length
          "
          class="text-sm text-gray-400"
        >
          Sin materiales.
        </div>
      </div>

      <div class="flex justify-between text-sm mt-4">
        <button
          class="text-blue-600 hover:underline"
          (click)="editar(servicio)"
        >
          Editar
        </button>
        <button
          class="text-red-600 hover:underline"
          (click)="eliminar(servicio.id!)"
        >
          Eliminar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Formulario -->
<div *ngIf="mostrarFormulario()" class="p-8 max-w-4xl mx-auto">
  <h2 class="text-2xl font-bold mb-6 text-center">
    {{ modoEdicion() ? "Editar" : "Agregar" }} servicio
  </h2>

  <form
    [formGroup]="form"
    (ngSubmit)="enviar()"
    class="grid grid-cols-1 gap-6 bg-white p-6 rounded shadow"
  >
    <!-- Nombre -->
    <div class="flex flex-col">
      <label class="mb-1 font-medium text-gray-700">Nombre del servicio</label>
      <input
        type="text"
        formControlName="nombre"
        class="w-full p-2 border rounded"
      />
    </div>

    <!-- Descripción -->
    <div class="flex flex-col">
      <label class="mb-1 font-medium text-gray-700">Descripción</label>
      <textarea
        rows="4"
        formControlName="descripcion"
        class="w-full p-2 border rounded"
      ></textarea>
    </div>

    <!-- Documento -->
    <div class="flex flex-col">
      <label class="mb-1 font-medium text-gray-700">Documentación</label>
      <textarea
        rows="4"
        formControlName="archivoDocumento"
        class="w-full p-2 border rounded"
      ></textarea>
    </div>

    <!-- Botones (guardar servicio) -->
    <div class="flex gap-4 mt-2">
      <button
        type="submit"
        class="bg-indigo-700 text-white px-4 py-2 rounded hover:bg-indigo-800"
      >
        {{ modoEdicion() ? "Guardar cambios" : "Agregar" }}
      </button>
      <button
        type="button"
        class="text-gray-500 underline"
        (click)="cancelar()"
      >
        Cancelar
      </button>
    </div>

    <!-- ============================ -->
    <!--   Materiales del servicio    -->
    <!-- ============================ -->
    <div class="border-t pt-4" *ngIf="modoEdicion() && form.value.id">
      <h3 class="text-lg font-semibold mb-3">Materiales del servicio (BOM)</h3>

      <div formArrayName="materiales" class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-100">
            <tr>
              <th class="text-left p-2">Materia prima</th>
              <th class="text-right p-2">Cantidad requerida</th>
              <th class="text-left p-2">Unidad</th>
              <th class="p-2"></th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let fg of materialesFA.controls; let i = index"
              [formGroupName]="i"
              class="border-t"
            >
              <td class="p-2">
                <select
                  class="border rounded p-2 w-72"
                  formControlName="materiaPrimaId"
                >
                  <option [ngValue]="null">Seleccione...</option>
                  <option *ngFor="let m of materias()" [ngValue]="m.id">
                    {{ m.nombreProducto }}
                  </option>
                </select>
              </td>
              <td class="p-2 text-right">
                <input
                  type="number"
                  step="0.0001"
                  min="0"
                  class="border rounded p-2 w-36 text-right"
                  formControlName="cantidadRequerida"
                />
              </td>
              <td class="p-2">
                <input
                  type="text"
                  class="border rounded p-2 w-36"
                  formControlName="unidad"
                  placeholder="pz, m, l, etc."
                />
              </td>
              <td class="p-2 text-right">
                <button
                  type="button"
                  class="text-red-600 hover:underline"
                  (click)="removerMaterial(i)"
                >
                  Quitar
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="flex items-center gap-3 mt-3">
        <button
          type="button"
          class="border rounded px-3 py-1"
          (click)="agregarMaterial()"
        >
          + Agregar material
        </button>
        <button
          type="button"
          class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800"
          (click)="guardarMateriales()"
        >
          Guardar materiales
        </button>
      </div>

      <p class="text-xs text-gray-500 mt-1">
        Al guardar materiales se reemplaza la lista completa en el servicio.
      </p>
    </div>
  </form>
</div>
